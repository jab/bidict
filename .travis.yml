language: generic

env:
  global:
    - VENV_ROOT="$HOME/venv"
    - PYENV_ROOT="$HOME/.pyenv"
    - PYENV="$PYENV_ROOT/bin/pyenv"
    # Default Python version. Used for jobs that don't specify one.
    - PYVER=3.6.3

matrix:
  include:
    # Each job performs a single task, and sets a "TASK" var so it's evident in the build matrix.

    # One-off jobs. Override "script" to do something other than run the default (pytest).
    - env: TASK=build-docs
      before_script: travis_retry pip install -U Sphinx
      script: travis_retry ./build-docs.sh linkcheck
    - env: TASK=pylint
      before_script: travis_retry pip install -U pylint
      script: pylint bidict tests/*.py
    - env: TASK=flake8
      before_script: travis_retry pip install -U flake8
      script: flake8 bidict tests/*.py
    - env: TASK=pydocstyle
      before_script: travis_retry pip install -U pydocstyle
      script: pydocstyle bidict
    - env: TASK=test-with-optimization-flag
      script: python3 -O -m doctest -o IGNORE_EXCEPTION_DETAIL -o ELLIPSIS tests/*.txt

    # Test with all supported Python versions on Linux.
    # Only run these tests for master since they're so slow on Travis.
    - env: TASK=pytest PYVER=2.7.14
      if: branch = master
    - env: TASK=pytest PYVER=3.4.7
      if: branch = master
    - env: TASK=pytest PYVER=3.5.3
      if: branch = master
    # Enable coverage for the latest stable Python 3 release on Linux.
    - env: TASK=pytest PYVER=3.6.3 COVERAGE=1
      if: branch = master
      before_script: travis_retry pip install -e .[coverage]
      script:
        - |
            py.test --cov=bidict --cov-config=.coveragerc || exit 1
            travis_retry pip install coveralls || exit 1
            coveralls
    - env: TASK=pytest PYVER=3.7-dev
      if: branch = master
    - env: TASK=pytest PYVER=pypy2.7-5.9.0
      if: branch = master
    - env: TASK=pytest PYVER=pypy3.5-5.9.0
      if: branch = master

    # Test with all supported Python versions on macOS.
    - env: TASK=pytest PYVER=2.7.14
      if: branch = master
      os: osx
      osx_image: xcode9.1
    - env: TASK=pytest PYVER=3.4.7
      if: branch = master
      os: osx
      osx_image: xcode9.1
    - env: TASK=pytest PYVER=3.5.3
      if: branch = master
      os: osx
      osx_image: xcode9.1
    - env: TASK=pytest PYVER=3.6.3
      if: branch = master
      os: osx
      osx_image: xcode9.1
    - env: TASK=pytest PYVER=3.7-dev
      if: branch = master
      os: osx
      osx_image: xcode9.1
    - env: TASK=pytest PYVER=pypy2.7-5.9.0
      if: branch = master
      os: osx
      osx_image: xcode9.1
    - env: TASK=pytest PYVER=pypy3.5-5.9.0
      if: branch = master
      os: osx
      osx_image: xcode9.1
      # PyPy3 not available for osx64 via pyenv. Install from homebrew instead:
      before_install: brew update  # Do not remove: https://github.com/Homebrew/brew/issues/3299
      install:
        - brew install pypy3
        - pip_pypy3 install -e .[test]
      script: pypy3 -m pytest

before_install:
  # Install pyenv and use it to install the Python version in $PYVER.
  - |
      echo "TRAVIS_PULL_REQUEST_SHA: $TRAVIS_PULL_REQUEST_SHA"
      echo "TRAVIS_COMMIT: $TRAVIS_COMMIT"
      git --no-pager log -n2
      echo
      echo "Ensuring up-to-date pyenv..."
      if [[ -f "$PYENV" ]]; then
        cd "$PYENV_ROOT"
        git pull
        cd -
      else
        rm -rf "$PYENV_ROOT"
        git clone --depth 1 https://github.com/yyuu/pyenv.git "$PYENV_ROOT"
      fi
      echo
      echo "Insalling Python version $PYVER..."
      "$PYENV" install --skip-existing "$PYVER"
      export PYTHON="$PYENV_ROOT/versions/$PYVER/bin/python"
      echo "$PYTHON --version"
      $PYTHON --version
      echo
      echo "Ensuring up-to-date pip and virtualenv..."
      $PYTHON -m ensurepip --upgrade
      $PYTHON -m pip install --upgrade virtualenv
      echo
      echo "Creating and activating virtualenv at $VENV_ROOT..."
      $PYTHON -m virtualenv --python="$PYTHON" "$VENV_ROOT"
      source "$VENV_ROOT/bin/activate"
      echo "VIRTUAL_ENV=$VIRTUAL_ENV"

install:
  - travis_retry pip install -e .[test]
  - py.test --version

script:
  - py.test

before_cache:
  - rm -rf $HOME/.cache/pip/log

cache:
  directories:
    - $HOME/.cache/pip
    - $HOME/.hypothesis
    - $PYENV_ROOT

sudo: false

notifications:
  webhooks:
    urls:
      - https://webhooks.gitter.im/e/bf64fb45a633c0935b9b
  email:
    recipients: jab@math.brown.edu

deploy:
  - provider: pypi
    user: jab
    password:
      secure: B9LLgXkTbtjeC/IbH4wh9PEBzvKEAuYo3EBNW5f1xuLqVqtsysIyxJa5ar/FQ4qwUCBwZPFAXFurN3lLzRhb2Tc04YQ0GYVv6f8lkzwrjoWau4iB9Qt/nnvdRa7KryEJvtenHCAnwoEUaADCjkZjwo6fIA0hEOLB6/AYfhfgXYA=
    on:
      tags: true

  # https://docs.travis-ci.com/user/deployment/releases/
  - provider: releases
    api_key:
      secure: 02GCTV4ja1dWQqzIznOdvVdJfEcIIougCv2OsQapDr6KjtgzpcBvDC4Z57eDsZX2JwharKdz3CmYJaRLCIDkVCYiyBxovO6v8o4Kww21v/4KMkpBmoGQmn9WiR1NYiK+dxlQb59+9t/DTYT39Wq6ZD+3sCETRdRZgraMNZWr8sA=
    on:
      tags: true

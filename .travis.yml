language: generic

env:
  global:
    - PYENV_ROOT="$HOME/.pyenv"
    - PYENV="$PYENV_ROOT/bin/pyenv"
    #- BENCHMARK_DIR="$HOME/.benchmarks"
    #- BENCHMARK_SKIP="--benchmark-skip"

matrix:
  include:
    # dedicated job to just build the docs
    - language: python
      python: "3.6"
      env: ONLY_BUILD_DOCS=1

    # jobs to test on all supported python versions on Linux
    - os: linux
      env: PYENV_PYTHON_VER=2.7.14
    - os: linux
      env: PYENV_PYTHON_VER=3.5.3
    - os: linux
      env: PYENV_PYTHON_VER=3.6.3 BIDICT_COVERAGE_ENABLE=1  # only generate coverage report for this one job
    - os: linux
      env: PYENV_PYTHON_VER=pypy2.7-5.9.0
    - os: linux
      env: PYENV_PYTHON_VER=pypy3.5-5.9.0

    # test again on macOS
    - os: osx
      env: PYENV_PYTHON_VER=2.7.14
    - os: osx
      env: PYENV_PYTHON_VER=3.5.3
    - os: osx
      env: PYENV_PYTHON_VER=3.6.3
    - os: osx
      env: PYENV_PYTHON_VER=pypy2.7-5.9.0
    #- os: osx
    #- env: PYENV_PYTHON_VER=pypy3.5-5.9.0

before_install:
  - |
      git --no-pager log -n2
      echo "TRAVIS_PULL_REQUEST_SHA: $TRAVIS_PULL_REQUEST_SHA"
      echo "TRAVIS_COMMIT: $TRAVIS_COMMIT"

install:
  # based on https://github.com/frol/flask-restplus-server-example/blob/018f48e5/.travis.yml
  - |
      set -ex
      if [[ -n "$PYENV_PYTHON_VER" ]]; then
        if [[ -f "$PYENV" ]]; then
          pushd "$PYENV_ROOT" && git pull && popd
        else
          rm -rf "$PYENV_ROOT" && git clone --depth 1 https://github.com/yyuu/pyenv.git "$PYENV_ROOT"
        fi
        "$PYENV" install --skip-existing "$PYENV_PYTHON_VER"
        export PYTHON="$PYENV_ROOT/versions/$PYENV_PYTHON_VER/bin/python"
        $PYTHON -m ensurepip --upgrade
        $PYTHON -m pip install --upgrade virtualenv
        export VENV="$HOME/virtualenvs/$PYENV_PYTHON_VER"
        $PYTHON -m virtualenv --python="$PYTHON" "$VENV"
        source "$VENV/bin/activate"
      fi
  - travis_retry pip install -e .[test]
  - test -z "$BIDICT_COVERAGE_ENABLE" || travis_retry pip install coveralls

script:
  - test -n "$ONLY_BUILD_DOCS" && ./build-docs.sh || ./test.sh

cache:
  directories:
    - $HOME/.cache/pip
    - $HOME/.hypothesis
    - $PYENV_ROOT
    #- $BENCHMARK_DIR

before_cache:
  - rm -rf $HOME/.cache/pip/log

after_success:
  - test -z "$BIDICT_COVERAGE_ENABLE" || coveralls

sudo: false

notifications:
  webhooks:
    urls:
      - https://webhooks.gitter.im/e/bf64fb45a633c0935b9b

deploy:
  provider: pypi
  user: jab
  password:
    secure: B9LLgXkTbtjeC/IbH4wh9PEBzvKEAuYo3EBNW5f1xuLqVqtsysIyxJa5ar/FQ4qwUCBwZPFAXFurN3lLzRhb2Tc04YQ0GYVv6f8lkzwrjoWau4iB9Qt/nnvdRa7KryEJvtenHCAnwoEUaADCjkZjwo6fIA0hEOLB6/AYfhfgXYA=
  on:
    tags: true
    branch: master
